<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-main: #0f172a;
            --bg-sidebar: #1e293b;
            --surface: #1e293b;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #818cf8;
            --accent-hover: #6366f1;
            --danger: #f87171;
            --danger-hover: #ef4444;
            --stat-1: #fbbf24;
            --stat-2: #34d399;
            --stat-3: #f472b6;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { 
            background-color: var(--bg-main); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
        }

        .surface { background-color: var(--surface); border: 1px solid var(--border); }
        .sidebar { background-color: var(--bg-sidebar); border-right: 1px solid var(--border); }

        .btn { transition: all 0.2s ease-in-out; border-radius: 0.5rem; padding: 0.6rem 1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; }
        .btn:disabled { background-color: var(--border); color: var(--text-secondary); cursor: not-allowed; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }
        .btn-secondary { background-color: var(--border); color: var(--text-primary); }
        .btn-secondary:hover:not(:disabled) { background-color: #475569; }

        #notification { transition: opacity 0.5s, transform 0.5s; z-index: 100; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .form-input { background-color: var(--bg-main); border: 1px solid var(--border); color: var(--text-primary); border-radius: 0.5rem; padding: 0.75rem; width: 100%; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); }
        .spinner { border: 4px solid var(--border); border-left-color: var(--accent); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .scrollable { overflow-y: auto; }
        .scrollable::-webkit-scrollbar { width: 6px; }
        .scrollable::-webkit-scrollbar-track { background: transparent; }
        .scrollable::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background-color: rgba(52, 211, 153, 0.2); color: #34d399; }
        .badge-warning { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-danger { background-color: rgba(248, 113, 113, 0.2); color: #f87171; }
        .badge-info { background-color: rgba(129, 140, 248, 0.2); color: #818cf8; }
    </style>
</head>
<body class="antialiased">

    <div class="relative flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 sidebar flex-shrink-0 flex flex-col absolute lg:relative inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <div class="h-20 flex items-center justify-center border-b border-[var(--border)]">
                <h1 class="text-2xl font-bold tracking-tight text-white">Library OS</h1>
            </div>
            <nav class="p-4 space-y-2">
                <a href="#" class="flex items-center gap-3 px-4 py-2 text-lg font-semibold rounded-lg bg-indigo-500/20 text-[var(--accent)]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                    Dashboard
                </a>
            </nav>
            <div class="p-4 border-t border-[var(--border)]">
                <div class="flex justify-between items-center mb-4 px-2">
                    <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Users</h3>
                    <button id="add-user-btn" class="btn btn-primary btn-sm !py-1 !px-3">Add</button>
                </div>
                <div class="px-2 mb-4">
                    <input type="text" id="user-search-input" placeholder="Filter users..." class="form-input text-sm w-full">
                </div>
                 <div id="users-list-sidebar" class="flex-grow scrollable pr-2 -mr-2 space-y-2 h-64">
                    <!-- User list for sidebar will be injected here -->
                </div>
            </div>
        </aside>
        
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden"></div>


        <!-- Main Content -->
        <div class="flex-1 flex flex-col w-full">
            <header class="h-20 flex items-center justify-between px-4 sm:px-8 border-b border-[var(--border)] surface flex-shrink-0">
                 <div class="flex items-center gap-4">
                    <button id="menu-toggle" class="lg:hidden text-[var(--text-secondary)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    </button>
                    <div class="hidden sm:block flex-grow">
                        <div id="book-search-form" class="relative flex items-center max-w-lg">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            <input type="text" id="book-search-input" placeholder="Search books..." class="form-input w-full pl-10 pr-32">
                            <select id="book-search-field" class="absolute right-1 top-1/2 -translate-y-1/2 bg-transparent form-input !border-0 !w-auto !pr-8 !pl-2 text-[var(--text-secondary)] text-sm focus:!ring-0">
                                <option value="title">By Title</option>
                                <option value="author">By Author</option>
                                <option value="isbn">By ISBN</option>
                                <option value="genre">By Genre</option>
                                <option value="publisher">By Publisher</option>
                                <option value="uuid">By UUID</option>
                            </select>
                        </div>
                    </div>
                 </div>
                 <div class="flex items-center gap-4">
                     <button id="add-book-btn" class="btn btn-primary">Add Book</button>
                </div>
            </header>

            <main class="flex-1 flex flex-col gap-6 p-4 sm:p-6 overflow-y-auto">
                 <div class="block sm:hidden flex-grow-0 mb-2">
                     <div id="book-search-form-mobile" class="relative flex items-center w-full">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-[var(--text-secondary)]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <input type="text" id="book-search-input-mobile" placeholder="Search books..." class="form-input w-full pl-10 pr-32">
                        <select id="book-search-field-mobile" class="absolute right-1 top-1/2 -translate-y-1/2 bg-transparent form-input !border-0 !w-auto !pr-8 !pl-2 text-[var(--text-secondary)] text-sm focus:!ring-0">
                            <option value="title">By Title</option>
                            <option value="author">By Author</option>
                            <option value="isbn">By ISBN</option>
                        </select>
                    </div>
                </div>

                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="surface rounded-lg p-6">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">Total Books</h3>
                        <p id="total-books-stat" class="text-4xl font-bold mt-2" style="color: var(--stat-1)">0</p>
                    </div>
                    <div class="surface rounded-lg p-6">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">Total Users</h3>
                        <p id="total-users-stat" class="text-4xl font-bold mt-2" style="color: var(--stat-2)">0</p>
                    </div>
                    <div class="surface rounded-lg p-6">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">Active Transactions</h3>
                        <p id="active-transactions-stat" class="text-4xl font-bold mt-2" style="color: var(--stat-3)">0</p>
                    </div>
                    <div class="surface rounded-lg p-6">
                        <h3 class="text-sm font-medium text-[var(--text-secondary)]">Overdue Books</h3>
                        <p id="overdue-books-stat" class="text-4xl font-bold mt-2" style="color: var(--danger)">0</p>
                    </div>
                </div>

                <!-- Borrow Books Section -->
                <div class="surface rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Borrow Books</h3>
                    <form id="borrow-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">User ID or Email</label>
                                <input type="text" id="borrow-user-input" placeholder="Enter public_id or email..." class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Or Select User</label>
                                <select id="borrow-user-select" class="form-input" title="Select a user"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">ISBN or UUID</label>
                                <input type="text" id="borrow-book-input" placeholder="Enter ISBN or UUID..." class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">Or Select Book</label>
                                <select id="borrow-book-select" class="form-input" title="Select a book"></select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-full" id="borrow-submit-btn">Borrow Book</button>
                    </form>
                </div>

                <!-- Tab System for Books and Active Transactions -->
                <div class="surface rounded-lg flex-grow flex flex-col p-0 min-h-0">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-[var(--border)] flex-shrink-0">
                        <button id="tab-books" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-2 border-[var(--accent)] text-[var(--accent)] transition-colors" data-tab="books">
                            Book Collection
                        </button>
                        <button id="tab-transactions" class="tab-btn flex-1 px-6 py-4 font-semibold text-center border-b-2 border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" data-tab="transactions">
                            Active Transactions
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-grow flex flex-col min-h-0 p-4">
                        <!-- Books Tab -->
                        <div id="books-tab" class="tab-content flex-grow flex flex-col min-h-0">
                            <div id="books-list" class="flex-grow scrollable pr-2 -mr-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                                <!-- Book cards will be injected here -->
                            </div>
                        </div>

                        <!-- Active Transactions Tab -->
                        <div id="transactions-tab" class="tab-content hidden flex-grow flex flex-col min-h-0">
                            <div class="mb-4 flex-shrink-0">
                                <input type="text" id="transaction-search-input" placeholder="Search by user ID, user name, or transaction ID..." class="form-input w-full">
                            </div>
                            <div id="active-transactions-list" class="flex-grow scrollable pr-2 -mr-2 space-y-3">
                                <!-- Active transactions will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification" class="fixed top-24 right-5 opacity-0 transform translate-x-12 p-4 rounded-lg shadow-lg text-white max-w-sm"></div>
    
    <!-- Modal Placeholder -->
    <div id="modal" class="hidden"></div>

    <script>
        const API_BASE_URL = 'http://192.168.1.3:8000/api';
        // DOM Elements
        const booksListEl = document.getElementById('books-list');
        const usersListSidebarEl = document.getElementById('users-list-sidebar');
        const notificationEl = document.getElementById('notification');
        const modalEl = document.getElementById('modal');
        const bookSearchInput = document.getElementById('book-search-input');
        const bookSearchField = document.getElementById('book-search-field');
        const bookSearchInputMobile = document.getElementById('book-search-input-mobile');
        const bookSearchFieldMobile = document.getElementById('book-search-field-mobile');
        const userSearchInput = document.getElementById('user-search-input');
        const borrowUserSelect = document.getElementById('borrow-user-select');
        const borrowBookSelect = document.getElementById('borrow-book-select');
        const borrowUserInput = document.getElementById('borrow-user-input');
        const borrowBookInput = document.getElementById('borrow-book-input');
        const transactionSearchInput = document.getElementById('transaction-search-input');
        const totalBooksStat = document.getElementById('total-books-stat');
        const totalUsersStat = document.getElementById('total-users-stat');
        const activeTransactionsStat = document.getElementById('active-transactions-stat');
        const overdueBooksStat = document.getElementById('overdue-books-stat');
        const activeTransactionsListEl = document.getElementById('active-transactions-list');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const borrowForm = document.getElementById('borrow-form');
        const borrowSubmitBtn = document.getElementById('borrow-submit-btn');

        // State
        let currentBooks = [];
        let allUsers = [];
        let activeTransactions = [];

        // Icons & Spinners
        const loadingSpinner = '<div class="flex justify-center items-center h-full col-span-full"><div class="spinner"></div></div>';
        const iconEdit = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--text-secondary)] group-hover:text-[var(--accent)]"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>`;
        const iconDelete = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--text-secondary)] group-hover:text-[var(--danger)]"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>`;
        const iconReturn = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--text-secondary)] group-hover:text-[var(--stat-2)]"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>`;

        // Debounce Utility
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function isOverdue(dueDate) {
            return new Date(dueDate) < new Date();
        }
        
        // --- Core UI Functions ---
        function showNotification(message, isError = false) {
            notificationEl.textContent = message;
            notificationEl.className = `fixed top-24 right-5 p-4 rounded-lg shadow-lg text-white max-w-sm surface ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notificationEl.classList.remove('opacity-0', 'translate-x-12');
            setTimeout(() => notificationEl.classList.add('opacity-0', 'translate-x-12'), 3000);
        }

        function openModal(title, formHtml, submitHandler) {
            modalEl.innerHTML = `<div class="modal-overlay" id="modal-overlay-bg"><div class="surface p-6 rounded-xl w-11/12 max-w-md shadow-2xl"><h3 class="text-xl font-semibold mb-4">${title}</h3><form id="modal-form">${formHtml}<div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div></form></div></div>`;
            modalEl.classList.remove('hidden');
            
            const overlayBg = document.getElementById('modal-overlay-bg');
            const modalContent = overlayBg.querySelector('.surface');
            
            overlayBg.addEventListener('click', (e) => {
                if (!modalContent.contains(e.target)) {
                    closeModal();
                }
            });
            
            document.getElementById('modal-form').addEventListener('submit', submitHandler);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
        }

        function openConfirmationModal(message, onConfirm) {
            modalEl.innerHTML = `<div class="modal-overlay" id="modal-overlay-bg"><div class="surface p-6 rounded-xl w-11/12 max-w-md shadow-2xl"><h3 class="text-xl font-semibold mb-2">Are you sure?</h3><p class="text-[var(--text-secondary)]">${message}</p><div class="flex justify-end gap-3 mt-6"><button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button><button type="button" id="confirm-btn" class="btn btn-danger">Confirm Delete</button></div></div></div>`;
            modalEl.classList.remove('hidden');
            
            const overlayBg = document.getElementById('modal-overlay-bg');
            const modalContent = overlayBg.querySelector('.surface');
            
            overlayBg.addEventListener('click', (e) => {
                if (!modalContent.contains(e.target)) {
                    closeModal();
                }
            });
            
            document.getElementById('confirm-btn').addEventListener('click', () => { onConfirm(); closeModal(); });
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
        }

        function closeModal() {
            modalEl.classList.add('hidden');
            modalEl.innerHTML = '';
        }

        // Generic API Handler
        async function apiRequest(endpoint, method, body, successMessage) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
                    throw new Error(errorResult.error || errorResult.message);
                }
                const result = method !== 'DELETE' ? await response.json() : null;
                if(successMessage) showNotification(successMessage);
                closeModal();
                return result;
            } catch (error) {
                showNotification(error.message, true);
                throw error;
            }
        }

        // Data Fetching and Rendering
        const debouncedBookSearch = debounce((params) => fetchAndRenderBooks(params), 400);
        const debouncedUserSearch = debounce((params) => fetchAndRenderUsers(params), 400);
        
        async function getBookCover(book) {
            const placeholder = 'https://placehold.co/128x192/1f2937/9ca3af?text=No+Cover';
            if (book.isbn) {
                try {
                    const openLibraryUrl = `https://covers.openlibrary.org/b/isbn/${book.isbn}-L.jpg?default=false`;
                    const response = await fetch(openLibraryUrl, { method: 'HEAD' });
                    if (response.ok && response.headers.get('content-type')?.startsWith('image/')) {
                        return openLibraryUrl;
                    }
                } catch (e) { /* Fallback */ }
                try {
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${book.isbn}&maxResults=1`);
                    const data = await response.json();
                    if (data.items?.[0]?.volumeInfo?.imageLinks?.thumbnail) {
                        return data.items[0].volumeInfo.imageLinks.thumbnail.replace("http://", "https://");
                    }
                } catch (error) { /* Fallback */ }
            }
            if (book.title) {
                try {
                    const query = `intitle:${encodeURIComponent(book.title)}${book.author ? `+inauthor:${encodeURIComponent(book.author)}` : ''}`;
                    const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=1`);
                    const data = await response.json();
                     if (data.items?.[0]?.volumeInfo?.imageLinks?.thumbnail) {
                        return data.items[0].volumeInfo.imageLinks.thumbnail.replace("http://", "https://");
                    }
                } catch (error) { /* Final fallback */ }
            }
            return placeholder;
        }

        async function fetchAndRenderBooks(queryParams = {}) {
            booksListEl.innerHTML = loadingSpinner;
            try {
                const queryString = new URLSearchParams(queryParams).toString();
                const response = await fetch(`${API_BASE_URL}/books?${queryString}`);
                if (!response.ok && response.status !== 404) throw new Error('Failed to fetch books');
                const result = response.status === 404 ? [] : await response.json();
                currentBooks = result.data || result;
                totalBooksStat.textContent = currentBooks.length;
                
                booksListEl.innerHTML = '';
                if (!Array.isArray(currentBooks) || currentBooks.length === 0) {
                    booksListEl.innerHTML = '<p class="text-[var(--text-secondary)] col-span-full text-center py-4">No books match your criteria.</p>';
                } else {
                    currentBooks.forEach(async (book) => {
                         const bookCard = document.createElement('div');
                        bookCard.className = 'surface rounded-lg p-4 flex flex-col justify-between shadow-sm hover:border-[var(--accent)] transition-colors';
                        bookCard.dataset.bookUuid = book.uuid;
                        bookCard.innerHTML = `
                            <div class="flex gap-4">
                                <img src="https://placehold.co/128x192/1f2937/374151?text=..." alt="Cover of ${book.title}" class="w-20 h-28 object-cover rounded flex-shrink-0 bg-[var(--border)]">
                                <div class="flex-grow min-w-0">
                                    <h4 class="font-bold text-md truncate">${book.title}</h4>
                                    <p class="text-sm text-[var(--text-secondary)] mb-2">by ${book.author}</p>
                                    <div class="text-xs text-[var(--text-muted)]">${book.genre || 'N/A'} &bull; ${book.publisher || 'N/A'}</div>
                                    <div class="mt-2 flex gap-2">
                                        <span class="badge badge-info">Available: ${book.available_quantity || 0}</span>
                                        <span class="badge badge-warning">Borrowed: ${book.borrowed_count || 0}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs font-mono text-[var(--text-secondary)] mt-3 border-t border-[var(--border)] pt-2 space-y-1">
                                <div><strong class="font-medium text-[var(--text-muted)]">ISBN:</strong> ${book.isbn || 'N/A'}</div>
                                <div class="truncate"><strong class="font-medium text-[var(--text-muted)]">UUID:</strong> ${book.uuid}</div>
                            </div>
                            <div class="flex items-center justify-end gap-3 mt-4">
                                <button class="edit-book-btn group" data-uuid='${book.uuid}'>${iconEdit}</button>
                                <button class="delete-book-btn group" data-uuid='${book.uuid}'>${iconDelete}</button>
                            </div>`;
                        booksListEl.appendChild(bookCard);

                        const coverUrl = await getBookCover(book);
                        const imgEl = bookCard.querySelector('img');
                        imgEl.src = coverUrl;
                    });
                }
            } catch (error) {
                showNotification(error.message, true);
                booksListEl.innerHTML = `<p class="text-red-500 col-span-full">Error: ${error.message}</p>`;
            }
            updateBorrowUI();
        }

        async function fetchAndRenderUsers(queryParams = {}) {
            usersListSidebarEl.innerHTML = loadingSpinner;
            try {
                const queryString = new URLSearchParams(queryParams).toString();
                const result = await apiRequest(`/users?${queryString}`, 'GET');
                const users = Array.isArray(result) ? result : [result];
                if (Object.keys(queryParams).length === 0) {
                    allUsers = users;
                    totalUsersStat.textContent = allUsers.length;
                }
                renderUserList(users);
            } catch (error) {
                 if (error.message.includes('404')) {
                    renderUserList([]);
                 } else {
                    showNotification(error.message, true);
                    usersListSidebarEl.innerHTML = `<p class="text-red-500 px-2">Error</p>`;
                 }
            }
            updateBorrowUI();
        }

        function renderUserList(users) {
            usersListSidebarEl.innerHTML = '';
            if (users.length === 0) {
                usersListSidebarEl.innerHTML = '<p class="text-[var(--text-secondary)] text-center py-4 text-sm">No users found.</p>';
                return;
            }
            users.forEach(user => {
                 const userItemSidebar = document.createElement('div');
                userItemSidebar.className = 'flex justify-between items-center p-2 rounded-lg hover:bg-[var(--bg-main)] transition-colors';
                userItemSidebar.innerHTML = `
                    <div>
                        <span class="font-semibold text-sm">${user.name}</span>
                        <p class="text-xs text-[var(--text-secondary)]">${user.email}</p>
                        <p class="text-xs font-mono text-[var(--text-muted)] mt-1">${user.public_id}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-user-btn group" data-public-id='${user.public_id}'>${iconEdit}</button>
                        <button class="delete-user-btn group" data-public-id='${user.public_id}'>${iconDelete}</button>
                    </div>`;
                usersListSidebarEl.appendChild(userItemSidebar);
            });
        }

        async function fetchAndRenderActiveTransactions() {
            activeTransactionsListEl.innerHTML = loadingSpinner;
            try {
                const result = await apiRequest('/books?status=borrowed', 'GET');
                const borrowedBooks = Array.isArray(result) ? result : (result.data || []);
                
                const allLoans = [];
                borrowedBooks.forEach(book => {
                    if (book.loans && Array.isArray(book.loans)) {
                        book.loans.forEach(loan => {
                            allLoans.push({
                                ...loan,
                                book_title: book.title,
                                book_uuid: book.uuid
                            });
                        });
                    }
                });
                
                activeTransactions = allLoans;
                
                const overdueCount = allLoans.filter(loan => isOverdue(loan.due_date)).length;
                
                overdueBooksStat.textContent = overdueCount;
                activeTransactionsStat.textContent = allLoans.length;

                renderActiveTransactions(allLoans);
            } catch (error) {
                console.error('[v0] Error loading transactions:', error);
                activeTransactionsListEl.innerHTML = `<p class="text-[var(--text-secondary)] text-center py-4">No active transactions or unable to load.</p>`;
            }
        }

        function renderActiveTransactions(loansToRender) {
            activeTransactionsListEl.innerHTML = '';
            
            if (loansToRender.length === 0) {
                activeTransactionsListEl.innerHTML = '<p class="text-[var(--text-secondary)] text-center py-4">No active transactions.</p>';
                return;
            }

            loansToRender.forEach(loan => {
                const dueDate = new Date(loan.due_date);
                const isOverdueStatus = isOverdue(loan.due_date);
                const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                
                const transactionCard = document.createElement('div');
                transactionCard.className = `surface rounded-lg p-4 ${isOverdueStatus ? 'border-l-4 border-[var(--danger)]' : 'border-l-4 border-[var(--accent)]'}`;
                transactionCard.dataset.transactionId = loan.transaction_id;
                
                transactionCard.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-grow">
                            <h4 class="font-semibold text-base">${loan.book_title || 'Unknown Book'}</h4>
                            <div class="mt-3 space-y-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-[var(--text-secondary)]">Borrower:</span>
                                    <span class="text-sm font-semibold">${loan.user_name || 'Unknown User'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-[var(--text-secondary)]">User ID:</span>
                                    <span class="text-xs font-mono text-[var(--text-muted)] bg-[var(--bg-main)] px-2 py-1 rounded">${loan.borrowed_by || 'N/A'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-[var(--text-secondary)]">Transaction ID:</span>
                                    <span class="text-xs font-mono text-[var(--text-muted)] bg-[var(--bg-main)] px-2 py-1 rounded truncate" title="${loan.transaction_id}">${loan.transaction_id.substring(0, 12)}...</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-[var(--text-secondary)]">Due Date:</span>
                                    <span class="text-sm">${formatDate(loan.due_date)}</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                ${isOverdueStatus ? `<span class="badge badge-danger">OVERDUE by ${Math.abs(daysUntilDue)} days</span>` : `<span class="badge badge-success">${daysUntilDue} days remaining</span>`}
                            </div>
                        </div>
                        <button class="return-book-btn group flex-shrink-0" data-transaction-id='${loan.transaction_id}' title="Return this book">${iconReturn}</button>
                    </div>
                `;
                activeTransactionsListEl.appendChild(transactionCard);
            });
        }
        
        function updateBorrowUI() {
            borrowUserSelect.innerHTML = '<option value="">Select a user</option>';
            allUsers.forEach(user => {
                if(user.public_id) {
                    const option = document.createElement('option');
                    option.value = user.public_id;
                    option.textContent = `${user.name}`;
                    borrowUserSelect.appendChild(option);
                }
            });
            borrowBookSelect.innerHTML = '<option value="">Select a book</option>';
            const availableBooks = currentBooks.filter(book => (book.available_quantity > 0));
            availableBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.uuid;
                option.textContent = `${book.title} (${book.available_quantity} available)`;
                borrowBookSelect.appendChild(option);
            });
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            setupTabSystem();

            // Mobile Sidebar Toggle
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });
            
            // Add Book
            document.getElementById('add-book-btn').addEventListener('click', () => {
                 const formHtml = `<input type="text" name="title" placeholder="Title" class="form-input mb-3" required><input type="text" name="author" placeholder="Author" class="form-input mb-3" required><input type="text" name="isbn" placeholder="ISBN (Optional)" class="form-input mb-3"><input type="text" name="publisher" placeholder="Publisher (Optional)" class="form-input mb-3"><input type="text" name="genre" placeholder="Genre (Optional)" class="form-input mb-3"><input type="number" name="quantity" placeholder="Quantity" value="1" min="1" class="form-input" required>`;
                openModal('Add New Book', formHtml, async (ev) => {
                    ev.preventDefault();
                    const data = Object.fromEntries(new FormData(ev.target).entries());
                    data.quantity = parseInt(data.quantity, 10);
                    await apiRequest('/books', 'POST', data, 'Book added successfully').then(() => fetchAndRenderBooks());
                });
            });

            // Add User
            document.getElementById('add-user-btn').addEventListener('click', () => {
                 const formHtml = `<input type="text" name="name" placeholder="User Name" class="form-input mb-3" required><input type="email" name="email" placeholder="User Email" class="form-input" required>`;
                openModal('Register New User', formHtml, async (ev) => {
                    ev.preventDefault();
                    const data = Object.fromEntries(new FormData(ev.target).entries());
                    await apiRequest('/users', 'POST', data, 'User registered successfully').then(() => fetchAndRenderUsers({}));
                });
            });
            
            // Book Search (Desktop & Mobile)
            const handleBookSearch = (field, value) => {
                const queryParams = {};
                if (value) { queryParams[field] = value; }
                debouncedBookSearch(queryParams);
            };
            bookSearchInput.addEventListener('keyup', () => handleBookSearch(bookSearchField.value, bookSearchInput.value.trim()));
            bookSearchField.addEventListener('change', () => handleBookSearch(bookSearchField.value, bookSearchInput.value.trim()));
            bookSearchInputMobile.addEventListener('keyup', () => handleBookSearch(bookSearchFieldMobile.value, bookSearchInputMobile.value.trim()));
            bookSearchFieldMobile.addEventListener('change', () => handleBookSearch(bookSearchFieldMobile.value, bookSearchInputMobile.value.trim()));

            // User Search
            userSearchInput.addEventListener('keyup', () => {
                const query = userSearchInput.value.trim();
                const queryParams = {};
                 if (query) {
                    if (query.includes('@') || (query.length > 4 && (query.includes('-') || !isNaN(query.substring(0,4))))) {
                        if (query.includes('@')) queryParams.email = query;
                        else queryParams.public_id = query;
                        debouncedUserSearch(queryParams);
                    } else {
                        const filtered = allUsers.filter(user => user.name.toLowerCase().includes(query.toLowerCase()));
                        renderUserList(filtered);
                    }
                } else {
                    renderUserList(allUsers);
                }
            });

            borrowForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                let userId = borrowUserSelect.value;
                if (!userId && borrowUserInput.value) {
                    const inputValue = borrowUserInput.value.trim();
                    const user = allUsers.find(u => u.public_id === inputValue || u.email === inputValue);
                    userId = user ? user.public_id : null;
                }
                
                let bookId = borrowBookSelect.value;
                if (!bookId && borrowBookInput.value) {
                    const inputValue = borrowBookInput.value.trim();
                    const book = currentBooks.find(b => b.isbn === inputValue || b.uuid === inputValue);
                    bookId = book ? book.uuid : null;
                }
                
                if (!userId || !bookId) {
                    showNotification('Please select or enter both a user and a book', true);
                    return;
                }

                borrowSubmitBtn.disabled = true;
                try {
                    const borrowData = {
                        public_id: userId,
                        books: [{ uuid: bookId }]
                    };
                    await apiRequest('/borrow', 'POST', borrowData, 'Book borrowed successfully');
                    borrowForm.reset();
                    borrowUserInput.value = '';
                    borrowBookInput.value = '';
                    await fetchAndRenderBooks();
                    await fetchAndRenderActiveTransactions();
                } catch (error) {
                    console.error('Borrow error:', error);
                } finally {
                    borrowSubmitBtn.disabled = false;
                }
            });

            document.body.addEventListener('click', async (e) => {
                const returnBtn = e.target.closest('.return-book-btn');
                if (returnBtn) {
                    const transactionId = returnBtn.dataset.transactionId;
                    openConfirmationModal('Are you sure you want to return this book?', async () => {
                        try {
                            const returnData = [{ transaction_id: transactionId }];
                            await apiRequest('/return', 'PATCH', returnData, 'Book returned successfully');
                            await fetchAndRenderActiveTransactions();
                            await fetchAndRenderBooks();
                        } catch (error) {
                            console.error('Return error:', error);
                        }
                    });
                }
            });

            // Event Delegation for Edit/Delete
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                if (target.classList.contains('delete-user-btn')) {
                    const publicId = target.dataset.publicId;
                    openConfirmationModal('This will permanently delete the user.', async () => {
                        await apiRequest(`/users/${publicId}`, 'DELETE', null, 'User deleted successfully').then(() => fetchAndRenderUsers({}));
                    });
                }
                if (target.classList.contains('delete-book-btn')) {
                    const uuid = target.dataset.uuid;
                    openConfirmationModal('This will permanently delete the book.', async () => {
                         await apiRequest('/books', 'DELETE', { uuid }, 'Book deleted successfully');
                        const cardToRemove = booksListEl.querySelector(`[data-book-uuid="${uuid}"]`);
                        if (cardToRemove) {
                            cardToRemove.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            cardToRemove.style.opacity = '0';
                            cardToRemove.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                cardToRemove.remove();
                                currentBooks = currentBooks.filter(book => book.uuid !== uuid);
                                totalBooksStat.textContent = currentBooks.length;
                                updateBorrowUI();
                                if (currentBooks.length === 0) {
                                    booksListEl.innerHTML = '<p class="text-[var(--text-secondary)] col-span-full text-center py-4">No books match your criteria.</p>';
                                }
                            }, 300);
                        }
                    });
                }
                if (target.classList.contains('edit-user-btn')) {
                     const publicId = target.dataset.publicId;
                    const formHtml = `<input type="text" name="newName" placeholder="New Name" class="form-input mb-3"><input type="email" name="newEmail" placeholder="New Email" class="form-input">`;
                    openModal('Edit User', formHtml, async (ev) => {
                        ev.preventDefault();
                        const data = Object.fromEntries(new FormData(ev.target).entries());
                        if (!data.newName && !data.newEmail) return showNotification('Please provide a new name or email.', true);
                        await apiRequest(`/users/${publicId}`, 'PATCH', data, 'User updated successfully').then(() => fetchAndRenderUsers({}));
                    });
                }
                if (target.classList.contains('edit-book-btn')) {
                     const uuid = target.dataset.uuid;
                    try {
                        const bookData = await apiRequest(`/books?uuid=${uuid}`, 'GET');
                        const bookToEdit = bookData[0];
                        if (!bookToEdit) return showNotification('Could not find book details to edit.', true);
                        
                        const formHtml = `
                            <input type="text" name="title" placeholder="Title" class="form-input mb-3" value="${bookToEdit.title || ''}">
                            <input type="text" name="author" placeholder="Author" class="form-input mb-3" value="${bookToEdit.author || ''}">
                            <input type="text" name="publisher" placeholder="Publisher" class="form-input mb-3" value="${bookToEdit.publisher || ''}">
                            <input type="text" name="genre" placeholder="Genre" class="form-input mb-3" value="${bookToEdit.genre || ''}">
                            <input type="text" name="isbn" placeholder="ISBN" class="form-input mb-3" value="${bookToEdit.isbn || ''}">
                            <input type="number" name="quantity" placeholder="Quantity" min="0" class="form-input" value="${bookToEdit.quantity || '0'}">`;
                        openModal('Edit Book', formHtml, async (ev) => {
                            ev.preventDefault();
                            const formData = new FormData(ev.target);
                            const edit_book_stack = [];
                            for (let [key, value] of formData.entries()) {
                                if (value && String(value) !== String(bookToEdit[key] || '')) {
                                    edit_book_stack.push({ colName: key, value: key === 'quantity' ? parseInt(value) : value });
                                }
                            }
                            if (edit_book_stack.length === 0) return showNotification('No changes were made.', false);
                            await apiRequest('/books', 'PATCH', { uuid, edit_book_stack }, 'Book updated successfully').then(() => fetchAndRenderBooks());
                        });
                    } catch(err) { console.error("Failed to open edit modal:", err); }
                }
            });

            transactionSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    renderActiveTransactions(activeTransactions);
                    return;
                }
                
                const filtered = activeTransactions.filter(loan => {
                    const userName = (loan.user_name || '').toLowerCase();
                    const userId = (loan.borrowed_by || '').toLowerCase();
                    const txnId = (loan.transaction_id || '').toLowerCase();
                    
                    return userName.includes(searchTerm) || 
                           userId.includes(searchTerm) || 
                           txnId.includes(searchTerm);
                });
                
                renderActiveTransactions(filtered);
            });
        }

        function setupTabSystem() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    
                    // Update button styles
                    tabBtns.forEach(b => {
                        b.classList.remove('border-[var(--accent)]', 'text-[var(--accent)]');
                        b.classList.add('border-transparent', 'text-[var(--text-secondary)]');
                    });
                    btn.classList.add('border-[var(--accent)]', 'text-[var(--accent)]');
                    btn.classList.remove('border-transparent', 'text-[var(--text-secondary)]');
                    
                    // Update tab content visibility
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
                });
            });
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            fetchAndRenderBooks();
            fetchAndRenderUsers({});
            fetchAndRenderActiveTransactions();
            setInterval(fetchAndRenderActiveTransactions, 30000);
        });
    </script>
</body>
</html>
